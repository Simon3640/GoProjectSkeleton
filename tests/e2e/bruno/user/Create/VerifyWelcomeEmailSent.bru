meta {
  name: VerifyWelcomeEmailSent
  type: http
  seq: 1.2
}

get {
  url: http://{{mailhogHost}}:8025/api/v1/message/{{lastMessageID}}
  body: none
  auth: inherit
}

script:post-response {
  const response = res.getBody();

  test("Response status code is 200", function () {
      expect(res.getStatus()).to.equal(200);
  });


  test("Email contains activation token", function () {
      const tokenMatch = response.Text.match(/token=([A-Za-z0-9\-_]+)/);
      expect(tokenMatch).to.exist;
      expect(tokenMatch[1]).to.exist;
  });

  test("Email is sent to correct recipient", function () {
      expect(response.To).to.exist;
      const toEmails = response.To.map(recipient => recipient.Address);
      const newUserEmail = bru.getEnvVar("newUserEmail");
      expect(toEmails).to.include(newUserEmail);
  });
}

settings {
  encodeUrl: true
  timeout: 0
}
