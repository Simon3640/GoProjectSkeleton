meta {
  name: GetMailPitMessages
  type: http
  seq: 2
}

get {
  url: http://{{mailhogHost}}:8025/api/v1/messages?limit=1
  body: none
  auth: inherit
}

params:query {
  limit: 1
}

script:pre-request {
  // Wait for mail
  bru.sleep(1000)
}

script:post-response {
  if (!res) {
    console.error("Response is undefined");
    return;
  }

  test("status code", function(){
      expect(res.getStatus()).to.equal(200);
  })

  // Get last message
  const response = res.getBody();

  if (!response || !response.messages || !response.messages[0]) {
    console.warn("Response body or messages array is missing");
    return;
  }

  // Get token to activate user
  bru.setEnvVar("lastMessageID", response.messages[0].ID)
}

settings {
  encodeUrl: true
  timeout: 0
}
