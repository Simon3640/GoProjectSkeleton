name: Deploy to Cloud

permissions:
  contents: read
  actions: write

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: 'Cloud provider (aws or azure)'
        required: true
        type: choice
        options:
          - aws
          - azure
      environment:
        description: 'Environment (development, staging, production)'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      terraform_action:
        description: 'Terraform action (plan, apply, destroy)'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'apply'
      deploy_functions:
        description: 'Deploy functions after Terraform (AWS only)'
        required: false
        type: boolean
        default: true

jobs:
  deploy:
    name: Deploy to ${{ inputs.cloud }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Configure AWS credentials
        if: inputs.cloud == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Configure Azure credentials
        if: inputs.cloud == 'azure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check AWS CLI version
        run: aws --version

      - name: Download dependencies
        run: make deps

      - name: Generate functions
        if: inputs.cloud == 'aws' && inputs.deploy_functions == true
        run: make build-aws-functions
      - name: Create terraform.tfvars
        if: inputs.cloud == 'aws' || inputs.cloud == 'azure'
        working-directory: src/infrastructure/clouds/${{ inputs.cloud }}/terraform
        run: |
          echo "${{ secrets.TFVARS }}" > terraform.tfvars

      - name: Generate Azure functions
        if: inputs.cloud == 'azure'
        run: make build-azure-functions

      - name: Terraform Init - AWS
        if: inputs.cloud == 'aws'
        working-directory: src/infrastructure/clouds/aws/terraform
        run: terraform init

      - name: Terraform Init - Azure
        if: inputs.cloud == 'azure'
        working-directory: src/infrastructure/clouds/azure/terraform
        run: terraform init

      - name: Terraform Validate - AWS
        if: inputs.cloud == 'aws'
        working-directory: src/infrastructure/clouds/aws/terraform
        run: terraform validate

      - name: Terraform Validate - Azure
        if: inputs.cloud == 'azure'
        working-directory: src/infrastructure/clouds/azure/terraform
        run: terraform validate

      - name: Terraform Plan - AWS
        if: inputs.cloud == 'aws' && inputs.terraform_action != 'destroy'
        working-directory: src/infrastructure/clouds/aws/terraform
        run: |
          terraform plan \
            -var="environment=${{ inputs.environment }}" \
            -out=tfplan
        continue-on-error: false

      - name: Generate Terraform Plan Summary - AWS
        if: inputs.cloud == 'aws' && inputs.terraform_action == 'plan'
        working-directory: src/infrastructure/clouds/aws/terraform
        run: terraform show -no-color tfplan > tfplan.txt || true

      - name: Upload Terraform Plan - AWS
        if: inputs.cloud == 'aws' && inputs.terraform_action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-aws-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            src/infrastructure/clouds/aws/terraform/tfplan
            src/infrastructure/clouds/aws/terraform/tfplan.txt
          retention-days: 30

      - name: Terraform Plan - Azure
        if: inputs.cloud == 'azure' && inputs.terraform_action != 'destroy'
        working-directory: src/infrastructure/clouds/azure/terraform
        run: |
          terraform plan \
            -var="environment=${{ inputs.environment }}" \
            -out=tfplan
        continue-on-error: false

      - name: Generate Terraform Plan Summary - Azure
        if: inputs.cloud == 'azure' && inputs.terraform_action == 'plan'
        working-directory: src/infrastructure/clouds/azure/terraform
        run: terraform show -no-color tfplan > tfplan.txt || true

      - name: Upload Terraform Plan - Azure
        if: inputs.cloud == 'azure' && inputs.terraform_action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-azure-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            src/infrastructure/clouds/azure/terraform/tfplan
            src/infrastructure/clouds/azure/terraform/tfplan.txt
          retention-days: 30

      - name: Terraform Apply - AWS
        if: inputs.cloud == 'aws' && inputs.terraform_action == 'apply'
        working-directory: src/infrastructure/clouds/aws/terraform
        run: terraform apply -auto-approve tfplan

      - name: Terraform Apply - Azure
        if: inputs.cloud == 'azure' && inputs.terraform_action == 'apply'
        working-directory: src/infrastructure/clouds/azure/terraform
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy - AWS
        if: inputs.cloud == 'aws' && inputs.terraform_action == 'destroy'
        working-directory: src/infrastructure/clouds/aws/terraform
        run: terraform destroy -auto-approve -var="environment=${{ inputs.environment }}"
        continue-on-error: ${{ inputs.environment != 'production' }}

      - name: Terraform Destroy - Azure
        if: inputs.cloud == 'azure' && inputs.terraform_action == 'destroy'
        working-directory: src/infrastructure/clouds/azure/terraform
        run: terraform destroy -auto-approve -var="environment=${{ inputs.environment }}"
        continue-on-error: ${{ inputs.environment != 'production' }}

      - name: Deploy AWS Lambda Functions
        if: inputs.cloud == 'aws' && inputs.deploy_functions == true && inputs.terraform_action == 'apply'
        env:
          PROJECT_NAME: ${{ secrets.PROJECT_NAME || 'go-project-skeleton' }}
          ENVIRONMENT: ${{ inputs.environment }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: make deploy-aws

      - name: Terraform Output - AWS
        if: inputs.cloud == 'aws' && inputs.terraform_action == 'apply'
        working-directory: src/infrastructure/clouds/aws/terraform
        run: terraform output

      - name: Terraform Output - Azure
        if: inputs.cloud == 'azure' && inputs.terraform_action == 'apply'
        working-directory: src/infrastructure/clouds/azure/terraform
        run: terraform output
