name: Desplegar Azure Functions

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/infrastructure/clouds/azure/functions/**'
      - 'src/**'
      - 'go.mod'
      - 'go.sum'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/infrastructure/clouds/azure/functions/**'
  workflow_dispatch:
    inputs:
      function_path:
        description: 'Ruta de la funciÃ³n a desplegar (ej: status/health_check)'
        required: false
        type: string
      environment:
        description: 'Entorno de despliegue'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  GO_VERSION: '1.25'
  AZURE_FUNCTIONS_VERSION: '4'

jobs:
  deploy-functions:
    name: Desplegar Azure Functions
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Autenticar con Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Obtener outputs de Terraform
        id: terraform-outputs
        working-directory: src/infrastructure/clouds/azure/terraform
        run: |
          # Inicializar Terraform si es necesario
          if [ ! -d ".terraform" ]; then
            terraform init
          fi

          # Obtener outputs
          FUNCTION_APP_NAME=$(terraform output -raw function_app_name 2>/dev/null || echo "")
          RESOURCE_GROUP=$(terraform output -raw resource_group_name 2>/dev/null || echo "")

          if [ -z "$FUNCTION_APP_NAME" ] || [ -z "$RESOURCE_GROUP" ]; then
            echo "âŒ Error: No se pudieron obtener los outputs de Terraform"
            echo "AsegÃºrate de que Terraform haya sido aplicado primero:"
            echo "  cd src/infrastructure/clouds/azure/terraform"
            echo "  terraform init"
            echo "  terraform apply"
            exit 1
          fi

          echo "FUNCTION_APP_NAME=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "RESOURCE_GROUP=$RESOURCE_GROUP" >> $GITHUB_OUTPUT

          echo "âœ… Function App: $FUNCTION_APP_NAME"
          echo "âœ… Resource Group: $RESOURCE_GROUP"

      - name: Verificar que el Function App existe
        run: |
          FUNCTION_APP_NAME="${{ steps.terraform-outputs.outputs.FUNCTION_APP_NAME }}"
          RESOURCE_GROUP="${{ steps.terraform-outputs.outputs.RESOURCE_GROUP }}"

          if ! az functionapp show --name "$FUNCTION_APP_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "âŒ Error: Function App '$FUNCTION_APP_NAME' no existe"
            echo "Ejecuta 'terraform apply' primero para crear la infraestructura"
            exit 1
          fi
          echo "âœ… Function App verificado"

      - name: Instalar Azure Functions Core Tools
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
          sudo apt-get update
          sudo apt-get install -y azure-functions-core-tools-4

      - name: Detectar funciones modificadas
        id: detect-functions
        run: |
          FUNCTION_PATH="${{ github.event.inputs.function_path }}"

          if [ -n "$FUNCTION_PATH" ]; then
            # Si se especificÃ³ una funciÃ³n manualmente
            echo "FUNCTIONS=$FUNCTION_PATH" >> $GITHUB_OUTPUT
            echo "âœ… Desplegando funciÃ³n especÃ­fica: $FUNCTION_PATH"
          else
            # Detectar funciones modificadas
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_REF="${{ github.event.pull_request.base.sha }}"
              HEAD_REF="${{ github.event.pull_request.head.sha }}"
            else
              BASE_REF="${{ github.event.before }}"
              HEAD_REF="${{ github.event.after }}"
            fi

            # Buscar funciones modificadas
            CHANGED_FUNCTIONS=$(git diff --name-only $BASE_REF $HEAD_REF | \
              grep -E 'src/infrastructure/clouds/azure/functions/[^/]+/[^/]+/' | \
              sed 's|src/infrastructure/clouds/azure/functions/||' | \
              sed 's|/.*||' | \
              sort -u | \
              tr '\n' ' ')

            if [ -z "$CHANGED_FUNCTIONS" ]; then
              # Si no hay cambios especÃ­ficos, desplegar todas las funciones
              CHANGED_FUNCTIONS=$(find src/infrastructure/clouds/azure/functions -mindepth 2 -maxdepth 2 -type d -name "*" | \
                sed 's|src/infrastructure/clouds/azure/functions/||' | \
                tr '\n' ' ')
            fi

            echo "FUNCTIONS=$CHANGED_FUNCTIONS" >> $GITHUB_OUTPUT
            echo "âœ… Funciones a desplegar: $CHANGED_FUNCTIONS"
          fi

      - name: Desplegar funciones
        env:
          FUNCTION_APP_NAME: ${{ steps.terraform-outputs.outputs.FUNCTION_APP_NAME }}
        run: |
          FUNCTIONS="${{ steps.detect-functions.outputs.FUNCTIONS }}"

          if [ -z "$FUNCTIONS" ]; then
            echo "âš ï¸  No se detectaron funciones para desplegar"
            exit 0
          fi

          for FUNCTION_PATH in $FUNCTIONS; do
            FUNCTION_DIR="src/infrastructure/clouds/azure/functions/$FUNCTION_PATH"

            if [ ! -d "$FUNCTION_DIR" ]; then
              echo "âš ï¸  Directorio no encontrado: $FUNCTION_DIR"
              continue
            fi

            if [ ! -f "$FUNCTION_DIR/main.go" ] || [ ! -f "$FUNCTION_DIR/function.json" ]; then
              echo "âš ï¸  No es una funciÃ³n vÃ¡lida (falta main.go o function.json): $FUNCTION_DIR"
              continue
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Desplegando funciÃ³n: $FUNCTION_PATH"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            cd "$FUNCTION_DIR"

            # Descargar dependencias
            echo "ğŸ“¦ Descargando dependencias..."
            go mod download

            # Construir
            echo "ğŸ”¨ Construyendo funciÃ³n..."
            go build -o main .

            # Desplegar
            echo "â˜ï¸  Desplegando a Azure Functions..."
            func azure functionapp publish "$FUNCTION_APP_NAME" --force --no-build

            echo "âœ… FunciÃ³n $FUNCTION_PATH desplegada exitosamente"
            cd - > /dev/null
          done

      - name: Mostrar informaciÃ³n del despliegue
        run: |
          FUNCTION_APP_NAME="${{ steps.terraform-outputs.outputs.FUNCTION_APP_NAME }}"
          FUNCTION_APP_URL="https://${FUNCTION_APP_NAME}.azurewebsites.net"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Despliegue completado"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ InformaciÃ³n:"
          echo "   Function App: $FUNCTION_APP_NAME"
          echo "   URL Base: $FUNCTION_APP_URL"
          echo ""
          echo "ğŸ§ª Para probar las funciones:"
          echo "   Health Check: ${FUNCTION_APP_URL}/api/health-check"
          echo ""
          echo "ğŸ“Š Para ver los logs:"
          echo "   az functionapp log tail --name $FUNCTION_APP_NAME --resource-group ${{ steps.terraform-outputs.outputs.RESOURCE_GROUP }}"
